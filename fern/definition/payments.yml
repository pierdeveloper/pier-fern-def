# yaml-language-server: $schema=https://raw.githubusercontent.com/fern-api/fern/main/fern.schema.json

docs: |
  Loan payments can be made using Pier via ACH

imports:
  commons: commons.yml
  facilities: facilities.yml

service:
  base-path: /payments
  auth: true
  endpoints:
    createACHAuthorization:
      display-name: Create ACH Authorization
      docs: |
        Creates an unsigned ACH authorization document for a specified facility. This is a required step before submitting a payment if repayment ACH is enabled. The user must agree to ACH withdrawals before Pier can initiate payments. This document is automatically signed by the user when you call POST /payments.
      path: "/api/facilities/:facility_id/create_ach_authorization"
      method: POST
      response: facilities.Facility
      errors:
        - commons.InvalidInputError
        - commons.FacilityNotFoundError
      examples:
        - response:
            body:
              terms:
                grace_period:
                  term: 0
                  interest_rate: 0
                amount: 100000
                apr: 200
                annual_fee: 0
                type: "revolving_line_of_credit_offer"
                interest_rate: 200
                late_payment_fee: 0
                origination_fee: 0
                id: "off_2e60b8c4fb7e4a10835e5a7e0641a5d8"
                minimum_payment:
                  type: "interest_plus_percentage_of_principal"
                  value: 250
                  floor: 1500
              id: $facilities.FacilityId.Example0
              application_id: "app_25fbcb8b8bd2417fab99b184678d2437"
              borrower_id: "bor_39addd1e5d7241cfa758e12388cd2fd4"
              loan_agreement_id: "doc_aac8a211dd9f49229dae022c5ecddccd"
              account_number: "652633487"
              credit_type: "consumer_revolving_line_of_credit"
              status: "active"
              autopay:
                authorized: false
              balance: 0
              origination_date: "2024-04-19"
              documents:
                unsigned_ach_authorization:
                  document_url: "https://storage.googleapis.com/download/storage/v1/b/pier_loan_docs/o/test%2Fdoc_db4efb43d1c0435ba5d730927d156fa6_unsigned.pdf?generation=1714045339730396&alt=media"
                  document_id: "doc_db4efb43d1c0435ba5d730927d156fa6"
              created_on: "2024-04-25T11:38:54.520Z"
              transactions: []
              statements: []
              payments_due: []

    submitPayment:
      display-name: Submit a loan payment
      docs: |
        Instructs Pier to initiate an ACH payment for a loan. If repayment_ach_enabled is false, use none for transfer_type.
      path: ""
      method: POST
      request: PaymentRequest
      response: Payment
      errors:
        - commons.InvalidInputError
        - commons.FacilityNotFoundError
        - commons.PaymentBalanceLessThanAmountError
        - commons.RepaymentAchDisabledError
        - commons.UnableToInitiatePaymentError
        - commons.MissingRepaymentBankDetailsError
      examples:
        - request: $PaymentRequest.Default
          response:
            body: $Payment.Pending
        - request: $PaymentRequest.DefaultNoneType
          response:
            body: $Payment.PendingNoneType

    get:
      display-name: Get a payment by ID
      docs: Get a payment by its id
      path: /{payment_id}
      path-parameters:
        payment_id: PaymentId
      method: GET
      response: Payment
      errors:
        - commons.PaymentNotFoundError
        - commons.InvalidPaymentIdError
      examples:
        - path-parameters:
            payment_id: $PaymentId.Example0
          response:
            body: $Payment.Pending

    refundPayment:
        display-name: Refund a payment
        docs: Refunds a specified payment in full. This endpoint is intended for correcting erroneous transactions. Only customers with ACH disabled can refund payments.
        path: "/{payment_id}/refund"
        path-parameters:
            payment_id: PaymentId
        method: POST
        response: facilities.RefundedPayment
        errors:
            - commons.PaymentNotFoundError
            - commons.InvalidPaymentIdError

    getAll:
      display-name: List all payments
      docs: List all payments associated with your account
      path: ""
      method: GET
      response: list<Payment>
      examples:
        - response:
            body:
              - $Payment.Pending
              - $Payment.Processing

    paymentTestInitiate:
      display-name: Move payment to initiated state
      docs: Move payment to initiated state (*sandbox only*)
      path: "/{payment_id}/test/initiate"
      path-parameters:
        payment_id: PaymentId
      method: PATCH
      response: string
      examples:
        - path-parameters:
            payment_id: pmt_234259b117854d0194bc5864a6c45b42
          response:
            body: "Ok."

    paymentTestSuccess:
      display-name: Move payment to successful state
      docs: Move payment to successful state (*sandbox only*)
      path: "/{payment_id}/test/success"
      path-parameters:
        payment_id: PaymentId
      method: PATCH
      response: string
      examples:
        - path-parameters:
            payment_id: pmt_234259b117854d0194bc5864a6c45b42
          response:
            body: "Ok."

    paymentTestFailed:
      display-name: Move payment to failed state
      docs: Move payment to failed state (*sandbox only*)
      path: "/{payment_id}/test/failed"
      path-parameters:
        payment_id: PaymentId
      method: PATCH
      response: string
      examples:
        - path-parameters:
            payment_id: pmt_234259b117854d0194bc5864a6c45b42
          response:
            body: "Ok."

types:
  PaymentId:
    type: string
    examples:
      - name: Example0
        value: pmt_18e5a3726b3943cda2635f40e1041ba4

  PaymentRequest:
    properties:
      facility_id:
        type: string
        docs: The facility_id of the credit facility to make a payment for
      amount:
        type: integer
        docs: The amount of the payment, in cents
      transfer_type:
        type: commons.TransferType
        docs: The type of ACH transfer
    examples:
      - name: Default
        value:
          facility_id: $facilities.FacilityId.Example0
          amount: 100000
          transfer_type: standard
      - name: DefaultNoneType
        value:
          facility_id: $facilities.FacilityId.Example0
          amount: 100000
          transfer_type: none

  Payment:
    properties:
      id: PaymentId
      amount:
        type: integer
        docs: The amount of the payment, in cents
      facility_id:
        type: string
        docs: The facility_id of the credit facility to make a payment for
      status:
        type: commons.TransferStatus
        docs: The status of the payment
      transfer_type:
        type: commons.TransferType
        docs: The type of ACH transfer
      created_on:
        type: datetime
        docs: Timestamp the payment is created on
      failure_reason:
        type: optional<string>
        docs: A reason for the failure if one exists
      is_autopay:
        type: optional<boolean>
        docs: If the payment was a result of an autopay
    examples:
      - name: Pending
        value:
          id: $PaymentId.Example0
          amount: 100000
          facility_id: $facilities.FacilityId.Example0
          status: pending
          transfer_type: standard
          created_on: 2023-02-27T00:00:00Z
          is_autopay: false
      - name: PendingNoneType
        value:
          id: $PaymentId.Example0
          amount: 100000
          facility_id: $facilities.FacilityId.Example0
          status: pending
          transfer_type: none
          created_on: 2023-02-27T00:00:00Z
          is_autopay: false
      - name: Processing
        value:
          id: $PaymentId.Example0
          amount: 100000
          facility_id: $facilities.FacilityId.Example0
          status: processing
          transfer_type: standard
          created_on: 2023-02-27T00:00:00Z
      - name: Settled
        value:
          id: $PaymentId.Example0
          amount: 100000
          facility_id: $facilities.FacilityId.Example0
          status: settled
          transfer_type: standard
          created_on: 2023-02-27T00:00:00Z
          is_autopay: false
      - name: Failed
        value:
          id: $PaymentId.Example0
          amount: 100000
          facility_id: $facilities.FacilityId.Example0
          status: failed
          transfer_type: standard
          created_on: 2023-02-27T00:00:00Z
          is_autopay: false
